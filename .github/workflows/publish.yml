# Please set 'QIITA_TOKEN' secret to your repository
name: Publish articles

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish_articles:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Convert relative image paths to raw URLs
        run: python3 .github/scripts/convert_image_paths.py "${{ github.repository }}" "${{ github.ref_name }}"

      - name: Publish changed articles (push)
        if: github.event_name == 'push'
        env:
          QIITA_TOKEN: ${{ secrets.QIITA_TOKEN }}
        run: |
          set -euo pipefail

          BEFORE_SHA="${{ github.event.before }}"
          AFTER_SHA="${{ github.sha }}"

          if [ -z "$BEFORE_SHA" ] || [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            BEFORE_SHA="${AFTER_SHA}~1"
          fi

          mapfile -t FILES < <(git diff --name-only "$BEFORE_SHA" "$AFTER_SHA" -- 'public/**/*.md' 'public/*.md' || true)

          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No changed articles under public/."
            exit 0
          fi

          BASENAMES=()
          for f in "${FILES[@]}"; do
            [ -f "$f" ] || continue
            BASENAMES+=("$(basename "$f" .md)")
          done

          if [ ${#BASENAMES[@]} -eq 0 ]; then
            echo "No publishable markdown files found."
            exit 0
          fi

          echo "Publishing: ${BASENAMES[*]}"
          npx qiita publish "${BASENAMES[@]}" --root .

      - name: Publish all articles (manual)
        if: github.event_name == 'workflow_dispatch'
        env:
          QIITA_TOKEN: ${{ secrets.QIITA_TOKEN }}
        run: npx qiita publish --all --root .
