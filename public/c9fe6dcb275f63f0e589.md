---
title: CUDA+ml-agentsの環境構築メモ
tags:
  - CUDA
  - Unity
  - 強化学習
  - ML-Agents
private: false
updated_at: '2025-03-30T19:44:15+09:00'
id: c9fe6dcb275f63f0e589
organization_url_name: null
slide: false
ignorePublish: false
---
## 動機

- ml-agentsでVisualObservationを行うとき、GPUで行うと計算速度の向上が見込めそう。
- →なので、CUDAを導入することにした

## 環境

- Windows 11（CUDA対応のGPUを積んでいるPC）
- [ML-Agents release22](https://github.com/Unity-Technologies/ml-agents/tree/release_22)
- python3.10

## 手順

### 1. CUDA Toolkitのインストール
- [こちら](https://developer.nvidia.com/cuda-toolkit-archive)からCUDA Toolkitをダウンロード。
- **バージョン**: CUDA 12.1

### 2. インストール確認
1. **環境変数の確認**
   - インストール後、以下のパスが通っていることを確認。
     `C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.1\bin`
2. コマンドプロンプトで`nvcc -V` と打ち込んで、以下のようなログが出れば成功
    ```bash
    Copyright (c) 2005-2023 NVIDIA Corporation
    Built on Wed_Feb__8_05:53:42_Coordinated_Universal_Time_2023
    Cuda compilation tools, release 12.1, V12.1.66
    Build cuda_12.1.r12.1/compiler.32415258_0
    ```

### 3. cuDNNのインストール
1. [こちら](https://developer.nvidia.com/rdp/cudnn-archive)からCUDA 12.1に対応したバージョン（8.9.0など）をダウンロード。
2. **下記フォルダを作成**（管理者権限が必要かも）:
   - `C:\Program Files\NVIDIA GPU Computing Toolkit\cuDNN`
3. ダウンロードしたファイルを解凍し、以下2.で作成したcuDNNフォルダ配下にコピー：
   - `bin`, `include`, `lib` フォルダと `LICENSE` ファイル。

### 4. 環境変数の登録
- システム環境変数に以下を追加：
  - **変数名**: `CUDNN_PATH`
    **値**: `C:\Program Files\NVIDIA GPU Computing Toolkit\cuDNN`
  - **Path**に以下を追加：
    `C:\Program Files\NVIDIA GPU Computing Toolkit\cuDNN\bin`

### 5. 仮想環境(venv)の作成と有効化
```bash
python -m venv venv
.\venv\Scripts\activate
```

### 6. PyTorchのインストール
- [公式サイト](https://pytorch.org/get-started/locally/)でstable → windows → Pip → Python → CUDA12.1　と選択
- おそらく下記と同じコマンドが表示されるので、コマンドプロンプトに打ち込んでインストール
```bash
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```

### 7. ml-agentsのインストール([参考](https://github.com/Unity-Technologies/ml-agents/blob/release_22/docs/Installation.md#advanced-local-installation-for-development-2))
以下のコマンドを実行：
   ```bash
   pip3 install -e ./ml-agents-envs
   pip3 install -e ./ml-agents
   ```

### 8. インストール確認
以下のPythonスクリプトを実行し、どちらも `True` なら成功：
```python
import torch

print(torch.cuda.is_available())  # CUDAが有効
print(torch.backends.cudnn.enabled)  # cuDNNが有効
```

---

## 強化学習実行方法

1. **学習コマンドにオプションを追加**:
   - `mlagents-learn`コマンドに`--torch-device=cuda`オプションを付与。

2. **GPU使用確認**:
   - タスクマネージャーのGPUのCuda使用率または`nvidia-smi`コマンドでGPUが正しく使用されている事を確認。
   - `nvidia-smi`でGPU情報が見れるのに、タスクマネージャーでCudaの使用率が見れない場合、以下の手順を踏むと治る。（[参考](https://stealthinu.hatenadiary.jp/entry/2022/07/30/183632)）
       - システム > ディスプレイ > グラフィック > 既定のグラフィック設定 >「ハードウェア　アクセラレータによる GPU スケジューリング」を「オフ」にする


## 参考資料
- [【Unity】ML-AgentsでGPUを使おうと頑張った話【強化学習】](https://note.com/nxino/n/ne5e82506a2ec)
- [【Windows】UnityのMLAgentsを利用するための環境構築](https://note.com/kohei_karita/n/n1a1d0d84c64e)
- [PyTorch-CUDA+cuDNN環境構築 on Windows 11](https://qiita.com/d83yk/items/f4e5019d3f4bbeaf36dc)
